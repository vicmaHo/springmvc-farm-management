<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::body})}">

<body>

    <div class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Producción</h2>
        </div>

        <div class="row g-3">

            <div class="col-md-6 col-lg-4" th:each="p : ${productions}">

                <div class="card shadow-sm h-100">

                    <div class="card-body">

                        <div class="d-flex justify-content-between">
                            <h5 th:text="${p.productionUnitName}"></h5>
                            <span class="badge bg-secondary" th:text="${p.date}">
                            </span>
                        </div>

                        <p class="h6" th:text="${'Cantidad: ' + p.quantityCount}">
                        </p>

                        <p class="h6"
                            th:text="${#numbers.formatDecimal(p.quantity, 2, 'POINT', 2, 'COMMA') + ' ' + p.unitOfMeasureSymbol}">
                        </p>

                        <p class="text-body-secondary" th:text="${p.notes}"></p>

                    </div>

                    <div class="card-footer bg-transparent d-flex justify-content-end gap-2">

                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#productionEditModal" th:attr="
                                    data-id=${p.id},
                                    data-production-unit-id=${p.productionUnitId},
                                    data-date=${p.date}, 
                                    data-quantity=${p.quantity},
                                    data-quantity-count=${p.quantityCount},
                                    data-unit-of-measure-id=${p.unitOfMeasureId},
                                    data-notes=${p.notes}
                                ">
                            Editar
                        </button>


                        <a th:href="@{/productions/delete/{id}(id=${p.id})}" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('¿Eliminr esta producción?')">
                            Eliminar
                        </a>

                    </div>

                </div>
            </div>

        </div>


    </div>

    <div class="modal fade" id="productionEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <form id="editProductionForm" th:action="@{/productions/edit}" method="post"
                    th:object="${productionUpdateRequest}">

                    <input type="hidden" th:field="*{id}" id="edit-id">

                    <div class="modal-header">
                        <h5 class="modal-title">Editar Producción</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control" th:field="*{date}" id="edit-date" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unidad de Producción</label>
                            <select class="form-select" th:field="*{productionUnitId}" id="edit-production-unit"
                                required>
                                <option th:each="pu : ${productionUnits}" th:value="${pu.id}" th:text="${pu.name}">
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cantidad de unidades</label>
                            <input type="number" step="0.01" class="form-control" th:field="*{quantityCount}"
                                id="edit-quantityCount">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unidad de medida</label>
                            <select class="form-select" th:field="*{unitOfMeasureId}" id="edit-unit-of-measure"
                                required>
                                <option th:each="u : ${unitOfMeasures}" th:value="${u.id}" th:text="${u.symbol}">
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" step="0.01" class="form-control" th:field="*{quantity}"
                                id="edit-quantity">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" th:field="*{notes}" id="edit-notes"></textarea>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>

                </form>

            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var productionEditModal = document.getElementById('productionEditModal');

            productionEditModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;

                var id = button.getAttribute('data-id');
                var date = button.getAttribute('data-date');
                var productionUnitId = button.getAttribute('data-production-unit-id');
                var quantityCount = button.getAttribute('data-quantity-count');
                var unitOfMeasureId = button.getAttribute('data-unit-of-measure-id');
                var quantity = button.getAttribute('data-quantity');
                var notes = button.getAttribute('data-notes');

                const form = document.getElementById('editProductionForm');
                form.action = '/productions/edit/' + id;



                document.getElementById('edit-id').value = id;

                document.getElementById('edit-date').value = date;

                document.getElementById('edit-production-unit').value = productionUnitId;

                document.getElementById('edit-quantityCount').value = quantityCount;

                document.getElementById('edit-unit-of-measure').value = unitOfMeasureId;

                document.getElementById('edit-quantity').value = quantity;

                document.getElementById('edit-notes').value = notes ? notes : '';
            });
        });
    </script>
</body>

</html>