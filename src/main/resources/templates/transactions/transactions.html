<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::body})}">

<body>

    <div class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Transacciones</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transactionModal">
                + Registrar Transacción
            </button>
        </div>

        <div class="row g-3">

            <div class="col-md-6 col-lg-4" th:each="t : ${transactions}">

                <div class="card shadow-sm h-100">

                    <div class="card-body">

                        <div class="d-flex justify-content-between">
                            <h5 th:text="${t.conceptName}"></h5>
                            <span class="badge bg-secondary" th:text="${t.date}">
                            </span>
                        </div>

                        <p class="text-muted mb-1" th:text="${t.productionUnitName}">
                        </p>

                        <p class="fw-bold fs-5"
                            th:text="'$' + ${#numbers.formatDecimal(t.amount, 1, 'POINT', 2, 'COMMA')}">
                        </p>

                        <p class="fw-bold mt-0 mb-1" th:text="${t.movementTypeName}" th:classappend="
                        ${t.movementTypeName == 'Ingreso'} ? ' text-success' :
                        (${t.movementTypeName == 'Egreso'} ? ' text-danger' :
                        (${t.movementTypeName == 'Regalo'} ? ' text-primary' : ''))">
                        </p>

                        <p class="text-body-secondary" th:text="${t.description}"></p>

                    </div>

                    <div class="card-footer bg-transparent d-flex justify-content-end gap-2">

                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#transactionEditModal" th:attr="
                                    data-id=${t.id},
                                    data-date=${t.date},
                                    data-amount=${t.amount},
                                    data-description=${t.description},
                                    data-concept-id=${t.conceptId},
                                    data-production-unit-id=${t.productionUnitId}
                                ">
                            Editar
                        </button>

                        <a th:href="@{/transactions/delete/{id}(id=${t.id})}" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('¿Eliminar transacción?')">
                            Eliminar
                        </a>

                    </div>

                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="transactionEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <form id="editTransactionForm" th:action="@{/transactions/edit}" method="post"
                    th:object="${transactionUpdateRequest}">

                    <input type="hidden" th:field="*{id}" id="edit-id">

                    <div class="modal-header">
                        <h5 class="modal-title">Editar Transacción</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control" th:field="*{date}" id="edit-date" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unidad de Producción</label>
                            <select class="form-select" th:field="*{productionUnitId}" id="edit-production-unit"
                                required>
                                <option th:each="pu : ${productionUnits}" th:value="${pu.id}"
                                    th:text="${pu.name}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Monto</label>
                            <input type="number" step="0.01" class="form-control" th:field="*{amount}" id="edit-amount"
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Concepto</label>
                            <select class="form-select" th:field="*{conceptId}" id="edit-concept" required>
                                <option th:each="c : ${concepts}" th:value="${c.id}" th:text="${c.name}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" th:field="*{description}" id="edit-description"></textarea>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>

                </form>

            </div>
        </div>
    </div>



    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <form th:action="@{/transactions/new}" method="post" th:object="${transactionCreateRequest}">

                    <div class="modal-header">
                        <h5 class="modal-title">Nueva Transacción</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control" th:field="*{date}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Monto</label>
                            <input type="number" step="0.01" class="form-control" th:field="*{amount}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" th:field="*{description}"></textarea>
                        </div>


                        <div class="mb-3">
                            <label class="form-label">Unidad de Producción</label>
                            <select class="form-select" th:field="*{productionUnitId}" required>
                                <option value="">Seleccione una unidad</option>
                                <option th:each="unit : ${productionUnits}" th:value="${unit.id}"
                                    th:text="${unit.name}">
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Concepto</label>
                            <select class="form-select" th:field="*{conceptId}" required>
                                <option value="">Seleccione un concepto</option>
                                <option th:each="concept : ${concepts}" th:value="${concept.id}"
                                    th:text="${concept.name}">
                                </option>
                            </select>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" th:field="*{createProduction}"
                                id="createProductionCheck">
                            <label class="form-check-label" for="createProductionCheck">
                                Registrar producción asociada
                            </label>
                        </div>

                        <div id="productionFields" style="display: none;">

                            <div class="mb-3">
                                <label class="form-label">Cantidad de Unidades (si aplica)</label>
                                <input type="number" step="0.01" class="form-control" th:field="*{quantityCount}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Cantidad (en volumen/peso) Total</label>
                                <input type="number" step="0.01" class="form-control" th:field="*{quantity}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Unidad de Medida</label>
                                <select class="form-select" th:field="*{unitOfMeasureId}">
                                    <option value="">Seleccione un concepto</option>
                                    <option th:each="measure : ${unitOfMeasures}" th:value="${measure.id}"
                                        th:text="${measure.name} + ' - '+ ${measure.symbol}">
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notas de la Producción</label>
                                <textarea class="form-control" th:field="*{notes}"></textarea>
                            </div>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            Guardar
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <script>
        document.getElementById('createProductionCheck')
            .addEventListener('change', function () {
                document.getElementById('productionFields').style.display =
                    this.checked ? 'block' : 'none';
            });
    </script>

    <script>
        const checkbox = document.getElementById('createProductionCheck');
        const productionFields = document.getElementById('productionFields');

        const productionInputs = productionFields.querySelectorAll('input, select');

        checkbox.addEventListener('change', function () {
            if (this.checked) {
                productionFields.style.display = 'block';
                productionInputs.forEach(input => input.setAttribute('required', 'required'));
            } else {
                productionFields.style.display = 'none';
                productionInputs.forEach(input => {
                    input.removeAttribute('required');
                    input.value = '';
                });
            }
        });
    </script>

    <script>
        const editModal = document.getElementById('transactionEditModal');

        if (editModal) {
            editModal.addEventListener('show.bs.modal', event => {

                const button = event.relatedTarget;

                const id = button.getAttribute('data-id');
                const date = button.getAttribute('data-date');
                const amount = button.getAttribute('data-amount');
                const description = button.getAttribute('data-description');

                const form = document.getElementById('editTransactionForm');
                form.action = '/transactions/edit/' + id;

                document.getElementById('edit-id').value = id;
                document.getElementById('edit-date').value = date;
                document.getElementById('edit-amount').value = amount;
                document.getElementById('edit-description').value = description;
            });
        }
    </script>
</body>

</html>